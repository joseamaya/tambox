{% extends "almacen/base_almacen.html" %}
{% block cuerpo %}
<h3>Aprobar Pedido / {{ pedido.codigo }}</h3>
<form role="form" method="post">
    <div class="row">
        <div class="col-lg-10">
            <input type="submit" class="btn btn-primary" name="submit" value="Guardar">
            <button type="button" class="btn btn-default"
                    onclick="location.href='{% url 'almacen:detalle_pedido' pedido.pk %}'">
                Cancelar
            </button>
        </div>
        <div class="col-lg-2 text-right">
            <div class="btn-group">
                <button class="btn btn-default" type="button"
                        onclick="location.href='{% url 'almacen:modificar_pedido' pedido.anterior %}';">
                    <span class="glyphicon glyphicon-step-backward"></span>
                </button>
                <button class="btn btn-default" type="button"
                        onclick="location.href='{% url 'almacen:modificar_pedido' pedido.siguiente %}';">
                    <span class="glyphicon glyphicon-step-forward"></span>
                </button>
                <button class="btn btn-default" type="button" onclick="location.href='{% url 'almacen:pedidos' %}';">
                    <span class="glyphicon glyphicon-th-list"></span>
                </button>
            </div>
        </div>
    </div>
    <hr/>
    <div class="panel panel-primary">
        <div class="panel-body">
            {% csrf_token %}
            <div class="form-group">
                <div class="row">
                    <div class="col-md-3">
                        <label>Código:</label>
                        {% if detalle_salida_form.codigo.errors %}
                        {% for error in detalle_salida_form.codigo.errors %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>Error: </strong> {{ error|escape }}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {{ form.cod_pedido }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label>Almacén:</label>
                        {% if detalle_salida_form.codigo.errors %}
                        {% for error in detalle_salida_form.codigo.errors %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>Error: </strong> {{ error|escape }}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {{ form.almacen }}
                    </div>
                    <div class="col-md-3">
                        <label>Fecha:</label>
                        {% if detalle_salida_form.codigo.errors %}
                        {% for error in detalle_salida_form.codigo.errors %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>Error: </strong> {{ error|escape }}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {{ form.fecha }}
                    </div>
                    <div class="col-md-3">
                        <label>Hora:</label>
                        {% if detalle_salida_form.codigo.errors %}
                        {% for error in detalle_salida_form.codigo.errors %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>Error: </strong> {{ error|escape }}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {{ form.hora }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <table id="detalles" class="table table-striped table-bordered table-hover">
                        <thead>
                        <tr>
                            <th>ID Producto</th>
                            <th>Producto</th>
                            <th>Unidad</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Valor</th>
                            <th>Acción</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{ detalle_salida_formset.management_form }}
                        {% for detalle_salida_form in detalle_salida_formset %}
                        <tr class="detalle_salida_formset">
                            <td>
                                {{ detalle_salida_form.pedido }}
                                {% if detalle_salida_form.codigo.errors %}
                                {% for error in detalle_salida_form.codigo.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.codigo }}
                            </td>
                            <td>
                                {% if detalle_salida_form.nombre.errors %}
                                {% for error in detalle_salida_form.nombre.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.nombre }}
                            </td>
                            <td>
                                {% if detalle_salida_form.unidad.errors %}
                                {% for error in detalle_salida_form.unidad.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.unidad }}
                            </td>
                            <td>
                                {% if detalle_salida_form.cantidad.errors %}
                                {% for error in detalle_salida_form.cantidad.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.cantidad }}
                            </td>
                            <td>
                                {% if detalle_salida_form.precio.errors %}
                                {% for error in detalle_salida_form.precio.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.precio }}
                            </td>
                            <td>
                                {% if detalle_salida_form.valor.errors %}
                                {% for error in detalle_salida_form.valor.errors %}
                                <div class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <strong>Error: </strong> {{ error|escape }}
                                </div>
                                {% endfor %}
                                {% endif %}
                                {{ detalle_salida_form.valor }}
                            </td>
                            <td>
                                <button class='eliminar btn btn-small btn-danger' type='button'
                                        id='id_form-{{ forloop.counter0 }}-btn-borrar' name='btn_borrar'>
                                    <span class='glyphicon glyphicon-remove'></span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <table id="tabla_total" class="table table-striped table-hover">
                        <tbody>
                        <tr>
                            <td WIDTH="50">
                            </td>
                            <td WIDTH="590">

                            </td>
                            <td WIDTH="50">
                                TOTAL
                            </td>
                            <td>
                                {{ form.total }}
                            </td>
                            <td WIDTH="80">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <label>OBSERVACIONES:</label>
                    {{ form.observaciones }}
                </div>
            </div>
            <div id="popup"></div>
            <div class="row">
                <div class="col-lg-4">
                    <input type="hidden" name="cdetalles" id="cdetalles" value={{ cant_detalles }}>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock cuerpo %}

{% block js %}
<script>
$(document).ready(function()
{
	var total=0;
	var contDetalles = $("#id_form-TOTAL_FORMS").val();
	var ultimo_item = contDetalles;
	var tipo_salida;	
	$("#id_fecha").datepicker();
	$('#id_hora').wickedpicker({now: mostrarhora(), twentyFour: true, title:'Hora de Salida', showSeconds: true});
	$("#id_almacen").on('change',verificar_stock_para_pedido);
	
	function agregarCero(n)
	{
	  if(n>9)
	  {
	    return n
	  }
	  else{
	    return "0"+n;
	  }
	}
	
	function verificar_stock_para_pedido()
	{	
		var almacen = $('#id_almacen').val();
		$.ajax({			
			data : {'almacen': almacen, 'pedido': "{{ pedido.codigo }}" },
			url : "{% url 'almacen:verificar_stock_para_pedido' %}",
			type : 'get',
			success : function(data)
			{
				$('#detalles td').parent().remove();
				contDetalles = 0;
				if(data=='')
				{
					alert("No se puede atender el pedido, no hay stock en el almacén seleccionado");
				}
				$.each(data, function(i,item){
					cont = i+1;
					$("#detalles tbody").append( 
					"<tr class='detalle_ingreso_formset'>" +
						"<td>" + item.pedido + item.codigo + "</td>" +
						"<td>" + item.nombre + "</td>" +
						"<td>" + item.unidad + "</td>" +
						"<td>" + item.cantidad + "</td>" +
						"<td>" + item.precio + "</td>" +
						"<td>" + item.valor + "</td>" +
				  		"<td><button class='eliminar btn btn-small btn-danger' type='button' id='id_form-"+i+"-btn-borrar' name='btn_borrar'><span class='glyphicon glyphicon-remove'></span></button></td>" +
					"</tr>");
					var val_temp = $("#id_form-"+i+"-valor").val();
					contDetalles=i+1;
					total = total + parseFloat(val_temp);
				});
				$("#id_form-TOTAL_FORMS").val(contDetalles);
				$("#id_total").val(total.toFixed(5));
				updateFormElementIndices('detalle_salida_formset');
				bindAutoComplete('productos');
				$(".decimal").keydown(validar_decimales);
			}
		});
	}
	
	function mostrarhora()
	{
		var f=new Date();
		cad=agregarCero(f.getHours())+" : "+agregarCero(f.getMinutes())+" : "+agregarCero(f.getSeconds());
		return cad;
	}
		
	$(document).on("click",".eliminar",function()
	{
		var parent = $(this).parent().parent();	
		var id_boton= $(this).prop('id');
		var id = id_boton.replace("btnBorrar","");
		var valor = $("#valor"+id).val();
		$(parent).remove();
		total=parseFloat(total-valor);
		$("#id_total").val(total.toFixed(5));
		contDetalles = contDetalles - 1;
	});
	
	$(document).on("keyup",".cantidad",function()
	{
		var id_cantidad= $(this).prop('id');
		var cantidad = $(this).val();
		var id = id_cantidad.replace("cantidad","");
		var codigo = $("#codigo"+id).val();
		var almacen = $('#id_almacenes').val();
		$.ajax({
	      url: "{% url 'almacen:consulta_stock' %}",
	      data: {
	    	  'almacen': almacen,
	    	  'codigo': codigo
	   	  },
	      success: function(data) 
	      {
			  if(cantidad>data.stock)
	          {
				  alert("La cantidad ingresada es mayor que el stock");
				  $("#cantidad"+id).val(data.stock);
				  $("#valor"+id).val($("#cantidad"+id).val()*$("#precio"+id).val());				  
	          }
	      }
	    });
		
	});
	
	$("form").submit(function(event) 
	{
		var cont=0;
		$('#cdetalles').val(ultimo_item);
		var almacen = $('#id_almacenes').val().trim();
		var fecha = $('#id_fecha').val().trim();
		if(almacen != '') 
		{			
			if(fecha != '')
			{					
				if (contDetalles > 0)
				{
					return;
				}
				else
				{
					alert("No ha ingresado ningún detalle");	
				}
			}
			else
			{
				alert("No ha seleccionado fecha");
			}
		}
		else
		{
			alert("No ha seleccionado almacén");
		}
		event.preventDefault();
	});
});

</script>
{% endblock js %}